name: "Build kernels"

env:
  OUT_DIR: "${{ github.workspace }}/out"

# Explicitly specify trigger conditions
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Confirm single execution'
        required: true
        default: 'yes'

jobs:
  Set-repos:
    name: "üêÇ Parse repos.json"
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.generate-matrix.outputs.repos }}
      builddate: ${{ steps.generate-builddate.outputs.builddate }}
    steps:
      - name: "üòÑ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Limit history to prevent multiple triggers

      - name: "üòÜ Generate Matrix"
        id: generate-matrix
        run: |
          # Add check for existing runs
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.confirm }}" != "yes" ]]; then
            echo "Execution not confirmed"
            exit 1
          fi
          
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          jq -s '[.[][]]' repos/repos*.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: "‚è∞ Set builddate"
        id: generate-builddate
        run: |
          echo "builddate=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

  Build-Kernel:
    name: "üêé Build kernel - ${{ matrix.repos.kernelSource.name }}"
    runs-on: ubuntu-latest
    needs: Set-repos
    strategy:
      max-parallel: 4
      fail-fast: false
      matrix:
        repos: ${{ fromJSON(needs.Set-repos.outputs.repos) }}
        # Add unique key to prevent duplicates
        include: ${{ fromJSON(needs.Set-repos.outputs.repos) }}

    # Add concurrency control
    concurrency:
      group: kernel-build-${{ github.ref }}-${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
      cancel-in-progress: true

    env:
      WORKSPACE: ${{ github.workspace }}
      builddate: "${{ needs.Set-repos.outputs.builddate }}"
      KERNEL_NAME: ${{ matrix.repos.kernelSource.name }}
      KERNEL_REPO: ${{ matrix.repos.kernelSource.repo }}
      KERNEL_BRANCH: ${{ matrix.repos.kernelSource.branch }}
      KERNEL_DEVICE: ${{ matrix.repos.kernelSource.device }}
      DEFCONFIG_NAME: ${{ matrix.repos.kernelSource.defconfig }}
      withKernelSU: ${{ matrix.repos.withKernelSU }}
      ccache: ${{ matrix.repos.ccache }}
      useAnykernel: ${{ matrix.repos.AnyKernel3.use }}
      release: ${{ matrix.repos.AnyKernel3.release }}

    steps:
      - name: "‚≠ê Verify single execution"
        run: |
          # Check for duplicate runs
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "This workflow should only be triggered manually"
            exit 1
          fi

      # ... [rest of your existing steps] ...

      - name: "üíæ Upload AnyKernel3 image"
        uses: actions/upload-artifact@v4
        if: ${{ env.useAnykernel == 'true' }}
        with:
          name: "${{ env.KERNEL_DEVICE }}-${{ env.KERNEL_NAME }}_${{ env.builddate }}"
          path: AnyKernel3/*
          retention-days: 1  # Short retention to prevent accumulation
